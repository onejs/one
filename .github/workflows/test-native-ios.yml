name: iOS Native Tests
env:
  # Specify an iOS version to test on.
  # Examples: "17", "18", "18-2", or leave it blank, which means any available version.
  simulator_ios_version: 18
  # Name of the simulator device to use.
  # Note that if you also specified an iOS version, the simulator device must be available for that version. To see available devices and their iOS versions, run `xcrun simctl list devices available --json | jq -r '[.devices | to_entries[] | select(.key | contains("SimRuntime.iOS")) | .key as $runtime | .value[] | { runtime: $runtime, name: .name, udid: .udid }]'`.
  # Examples: "iPhone 15 Pro", "iPhone 16 Pro Max".
  simulator_device_name: iPhone 16 Pro

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  check-trigger:
    name: Check Trigger Conditions
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if workflow should run
        id: check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          # Check for manual dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          # Check for native: prefix
          if [[ "$COMMIT_MSG" == native:* ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          # Check for version pattern v1.2.x
          if [[ "$COMMIT_MSG" =~ ^v1\.2\.[0-9]+ ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "should_run=false" >> $GITHUB_OUTPUT

  build-ios-test-container-dev:
    name: Build iOS RN Test App (Dev)
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    uses: ./.github/workflows/build-ios-test-container-app.yml
    secrets: inherit
    permissions:
      contents: read
      pull-requests: read
    with:
      configuration: Debug

  build-ios-test-container-prod:
    name: Build iOS RN Test App (Prod)
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    uses: ./.github/workflows/build-ios-test-container-app.yml
    secrets: inherit
    permissions:
      contents: read
      pull-requests: read
    with:
      configuration: Release

  test-ios-native:
    name: Native iOS Tests
    needs:
      - build-ios-test-container-dev
      - build-ios-test-container-prod
    runs-on: warp-macos-15-arm64-6x
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install
        uses: ./.github/actions/install

      - name: Download Built Test Container App (Dev)
        uses: actions/cache/restore@v4
        with:
          fail-on-cache-miss: true
          key: ${{ needs.build-ios-test-container-dev.outputs.built-app-cache-key }}
          path: ${{ needs.build-ios-test-container-dev.outputs.built-app-path }}

      - name: Download Built Test Container App (Prod)
        uses: actions/cache/restore@v4
        with:
          fail-on-cache-miss: true
          key: ${{ needs.build-ios-test-container-prod.outputs.built-app-cache-key }}
          path: ${{ needs.build-ios-test-container-prod.outputs.built-app-path }}

      - name: Get Simulator UDID
        id: get-simulator-udid
        env:
          SIMULATOR_IOS_VERSION: ${{ env.simulator_ios_version }}
          SIMULATOR_DEVICE_NAME: ${{ env.simulator_device_name }}
        run: |
          AVAILABLE_SIMULATORS=$(xcrun simctl list devices available --json | jq -r '[.devices | to_entries[] | select(.key | contains("SimRuntime.iOS")) | .key as $runtime | .value[] | { runtime: $runtime, name: .name, udid: .udid }]')
          echo "Available simulators: $AVAILABLE_SIMULATORS"

          SELECTED_SIMULATOR=$(echo $AVAILABLE_SIMULATORS | jq -r "[.[] | select(.runtime | contains(\"$SIMULATOR_IOS_VERSION\")) | select(.name | \"$SIMULATOR_DEVICE_NAME\")] | first")
          if [ -z "$SELECTED_SIMULATOR" ] || [ "$SELECTED_SIMULATOR" = "null" ]; then
            echo "Error: No simulator found for iOS version $SIMULATOR_IOS_VERSION and device name $SIMULATOR_DEVICE_NAME"
            exit 1
          fi
          echo "Selected simulator: $SELECTED_SIMULATOR"

          SIMULATOR_UDID=$(echo $SELECTED_SIMULATOR | jq -r .udid)
          if [ -z "$SIMULATOR_UDID" ] || [ "$SIMULATOR_UDID" = "null" ]; then
            echo "Error: Could not get simulator UDID"
            exit 1
          fi
          echo "Simulator UDID: $SIMULATOR_UDID"
          echo "simulator_udid=$SIMULATOR_UDID" >> $GITHUB_OUTPUT

      - name: Boot Simulator
        env:
          SIMULATOR_UDID: ${{ steps.get-simulator-udid.outputs.simulator_udid }}
        run: xcrun simctl boot $SIMULATOR_UDID

      - name: Get NPM Global Root Path
        id: get-npm-global-root-path
        run: |
          NPM_GLOBAL_ROOT_PATH=$(npm root -g)
          echo "NPM global root path: $NPM_GLOBAL_ROOT_PATH"
          echo "path=$NPM_GLOBAL_ROOT_PATH" >> $GITHUB_OUTPUT

      - uses: cirruslabs/cache/restore@v4
        with:
          path: ${{ steps.get-npm-global-root-path.outputs.path }}
          key: ${{ runner.os }}-npm-appium

      - name: Install and Run Appium Server
        run: |
          npm install -g appium
          appium driver install xcuitest
          appium > /tmp/appium.log &
          sleep 3

      - uses: cirruslabs/cache/save@v4
        with:
          path: ${{ steps.get-npm-global-root-path.outputs.path }}
          key: ${{ runner.os }}-npm-appium

      - name: Test Dev
        env:
          SIMULATOR_UDID: ${{ steps.get-simulator-udid.outputs.simulator_udid }}
          IOS_TEST_CONTAINER_PATH_DEV: ${{ github.workspace }}/${{ needs.build-ios-test-container-dev.outputs.built-app-path }}
        run: |
          bun run --filter test-test test-ios:dev && bun run --filter test-hmr test-ios:dev

      - name: Test Prod
        env:
          SIMULATOR_UDID: ${{ steps.get-simulator-udid.outputs.simulator_udid }}
          IOS_TEST_CONTAINER_PATH_PROD: ${{ github.workspace }}/${{ needs.build-ios-test-container-prod.outputs.built-app-path }}
        run: |
          bun run --filter test-test test-ios:prod && bun run --filter test-hmr test-ios:prod

      - name: Upload Appium Logs
        uses: actions/upload-artifact@v4.3.1
        if: ${{ always() }}
        continue-on-error: true
        with:
          name: appium-tests.log
          path: |
            /tmp/appium.log

      - name: Upload Appium Screenshots
        uses: actions/upload-artifact@v4.3.1
        if: ${{ always() }}
        continue-on-error: true
        with:
          name: appium-screenshots
          path: |
            /tmp/appium-screenshots
